const fs = require('fs');
const axios = require('axios');
const FormData = require('form-data');
require('dotenv').config({ path: './app-commons/environments/.env.local' });

async function uploadToXray() {
  const filePath = 'results.xml';
  if (!fs.existsSync(filePath)) {
    console.error('❌ File not found:', filePath);
    process.exit(1);
  }

  const form = new FormData();
  form.append('file', fs.createReadStream(filePath));

  try {
    const res = await axios.post(
      `${process.env.XRAY_JIRA_BASE_URL}/rest/raven/1.0/import/execution/junit?projectKey=${process.env.XRAY_PROJECT_KEY}`,
      form,
      {
        auth: {
          username: process.env.XRAY_USERNAME,
          password: process.env.XRAY_PASSWORD,
        },
        headers: form.getHeaders(),
      }
    );
    console.log('✅ Xray upload successful:', res.data);
  } catch (err) {
    console.error('❌ Upload failed:', err.response?.data || err.message);
  }
}

uploadToXray();
